// Generated by CoffeeScript 1.9.3
var AuthPanel, Button, ButtonGroup, ButtonInput, Col, Glyphicon, Input, LoginForm, Panel, Row, TeamManagementForm, update;

Input = ReactBootstrap.Input;

Row = ReactBootstrap.Row;

Col = ReactBootstrap.Col;

Button = ReactBootstrap.Button;

Panel = ReactBootstrap.Panel;

Glyphicon = ReactBootstrap.Glyphicon;

ButtonInput = ReactBootstrap.ButtonInput;

ButtonGroup = ReactBootstrap.ButtonGroup;

update = React.addons.update;

LoginForm = React.createClass({displayName: "LoginForm",
  render: function() {
    var formButton, lockGlyph, q, registrationForm, userGlyph;
    userGlyph = React.createElement(Glyphicon, {
      "glyph": "user"
    });
    lockGlyph = React.createElement(Glyphicon, {
      "glyph": "lock"
    });
    formButton = this.props.status === "Login" ? q = "'" : void 0;
    if (this.props.status === "Reset") {
      return React.createElement(Panel, null, React.createElement("form", {
        "onSubmit": this.props.onPasswordReset
      }, React.createElement("p", null, React.createElement("i", null, "A password reset link will be sent the user", q, "s email.")), React.createElement(Input, {
        "type": "text",
        "valueLink": this.props.username,
        "addonBefore": userGlyph,
        "placeholder": "Username",
        "required": "visible"
      }), React.createElement("div", {
        "style": {
          height: "70px"
        }
      }), React.createElement(Row, null, React.createElement(Col, {
        "md": 6.
      }, React.createElement(ButtonInput, {
        "type": "submit"
      }, "Reset Password")), React.createElement(Col, {
        "md": 6.
      }, React.createElement("span", {
        "className": "pull-right pad"
      }, "Go back to ", React.createElement("a", {
        "onClick": this.props.setPage.bind(null, "Login")
      }, "Login"), ".")))));
    } else {
      registrationForm = this.props.status === "Register" ? React.createElement("span", null, React.createElement(Row, null, React.createElement(Col, {
        "md": 6.
      }, React.createElement(Input, {
        "type": "text",
        "valueLink": this.props.firstname,
        "label": "Firstname"
      })), React.createElement(Col, {
        "md": 6.
      }, React.createElement(Input, {
        "type": "text",
        "valueLink": this.props.lastname,
        "label": "Lastname"
      }))), React.createElement(Row, null, React.createElement(Col, {
        "md": 12.
      }, React.createElement(Input, {
        "type": "email",
        "valueLink": this.props.email,
        "label": "E-mail"
      }))), React.createElement(ButtonInput, {
        "type": "submit"
      }, "Register")) : React.createElement("span", null);
      return React.createElement(Panel, null, React.createElement("form", {
        "key": this.props.status,
        "onSubmit": (this.props.status === "Login" ? this.props.onLogin : this.props.onRegistration)
      }, React.createElement(Input, {
        "type": "text",
        "valueLink": this.props.username,
        "addonBefore": userGlyph,
        "label": "Username"
      }), React.createElement(Input, {
        "type": "password",
        "valueLink": this.props.password,
        "addonBefore": lockGlyph,
        "label": "Password"
      }), React.createElement(Row, null, React.createElement(Col, {
        "md": 6.
      }, (this.props.status === "Register" ? React.createElement("span", {
        "className": "pad"
      }, "Go back to ", React.createElement("a", {
        "onClick": this.props.setPage.bind(null, "Login")
      }, "Login"), ".") : React.createElement("span", null, React.createElement(Button, {
        "type": "submit"
      }, "Login"), React.createElement(Button, {
        "onClick": this.props.setPage.bind(null, "Register")
      }, "Register")))), React.createElement(Col, {
        "md": 6.
      }, React.createElement("a", {
        "className": "pad",
        "onClick": this.props.setPage.bind(null, "Reset")
      }, "Need to reset your password?"))), registrationForm));
    }
  }
});

TeamManagementForm = React.createClass({displayName: "TeamManagementForm",
  mixins: [React.addons.LinkedStateMixin],
  getInitialState: function() {
    return {};
  },
  onTeamRegistration: function(e) {
    e.preventDefault();
    return apiCall("POST", "/api/team/create", {
      team_name: this.state.team_name,
      team_password: this.state.team_password
    }).done(function(resp) {
      switch (resp.status) {
        case 0:
          return apiNotify(resp);
        case 1:
          return document.location.href = "/profile";
      }
    });
  },
  onTeamJoin: function(e) {
    e.preventDefault();
    return apiCall("POST", "/api/team/join", {
      team_name: this.state.team_name,
      team_password: this.state.team_password
    }).done(function(resp) {
      switch (resp.status) {
        case 0:
          return apiNotify(resp);
        case 1:
          return document.location.href = "/profile";
      }
    });
  },
  render: function() {
    var lockGlyph, towerGlyph;
    towerGlyph = React.createElement(Glyphicon, {
      "glyph": "tower"
    });
    lockGlyph = React.createElement(Glyphicon, {
      "glyph": "lock"
    });
    return React.createElement(Panel, null, React.createElement("form", {
      "onSubmit": this.onTeamJoin
    }, React.createElement(Input, {
      "type": "text",
      "valueLink": this.linkState("team_name"),
      "addonBefore": towerGlyph,
      "label": "Team Name",
      "required": true
    }), React.createElement(Input, {
      "type": "password",
      "valueLink": this.linkState("team_password"),
      "addonBefore": lockGlyph,
      "label": "Team Password",
      "required": true
    }), React.createElement(Col, {
      "md": 6.
    }, React.createElement("span", null, " ", React.createElement(Button, {
      "type": "submit"
    }, "Join Team"), React.createElement(Button, {
      "onClick": this.onTeamRegistration
    }, "Register Team"))), React.createElement(Col, {
      "md": 6.
    }, React.createElement("a", {
      "href": "#",
      "onClick": (function() {
        return document.location.href = "/profile";
      })
    }, "Play as an individual."))));
  }
});

AuthPanel = React.createClass({displayName: "AuthPanel",
  mixins: [React.addons.LinkedStateMixin],
  getInitialState: function() {
    return {
      page: "Login",
      settings: {}
    };
  },
  componentWillMount: function() {
    return apiCall("GET", "/api/team/settings").done((function(req) {
      return this.setState(update(this.state, {
        settings: {
          $set: req.data
        }
      }));
    }).bind(this));
  },
  onRegistration: function(e) {
    e.preventDefault();
    return apiCall("POST", "/api/user/create_simple", this.state).done((function(resp) {
      apiNotify(resp);
      switch (resp.status) {
        case 1:
          if (this.state.settings.max_team_size > 1) {
            return this.setPage("Team Management");
          } else {
            return document.location.href = "/profile";
          }
      }
    }).bind(this));
  },
  onPasswordReset: function(e) {
    e.preventDefault();
    return apiCall("POST", "/api/user/reset_password", {
      username: this.state.username
    }).done((function(resp) {
      apiNotify(resp);
      if (resp.status === 1) {
        return this.setPage("Login");
      }
    }).bind(this));
  },
  onLogin: function(e) {
    e.preventDefault();
    return apiCall("POST", "/api/user/login", {
      username: this.state.username,
      password: this.state.password
    }).done(function(resp) {
      switch (resp.status) {
        case 0:
          return apiNotify(resp);
        case 1:
          if (resp.data.teacher) {
            return document.location.href = "/classroom";
          } else {
            return document.location.href = "/profile";
          }
      }
    });
  },
  setPage: function(page) {
    return this.setState(update(this.state, {
      page: {
        $set: page
      }
    }));
  },
  componentDidMount: function() {
    return $("input").prop('required', true);
  },
  componentDidUpdate: function() {
    return $("input").prop('required', true);
  },
  render: function() {
    var links;
    links = {
      username: this.linkState("username"),
      password: this.linkState("password"),
      lastname: this.linkState("lastname"),
      firstname: this.linkState("firstname"),
      email: this.linkState("email")
    };
    if (this.state.page === "Team Management") {
      return React.createElement("div", null, React.createElement(Col, {
        "md": 6.,
        "mdOffset": 3.
      }, React.createElement(TeamManagementForm, null)));
    } else {
      return React.createElement("div", null, React.createElement(Col, {
        "md": 6.,
        "mdOffset": 3.
      }, React.createElement(LoginForm, React.__spread({
        "setPage": this.setPage,
        "status": this.state.page,
        "onRegistration": this.onRegistration,
        "onLogin": this.onLogin,
        "onPasswordReset": this.onPasswordReset
      }, links))));
    }
  }
});

$(function() {
  return React.render(React.createElement(AuthPanel, null), document.getElementById("auth-box"));
});
